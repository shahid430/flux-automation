---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
metadata:
  name: flux-system
resources:
  - kube-prometheus-stack
  - ingress
#  - kong
  - loki-distributed
configMapGenerator:
  - name: loki-distributed
    namespace: monitoring
    behavior: merge
    literals:
      - loki-distributed.enabled=true
      - loki-distributed.promtail.enabled=true
      - loki-distributed.promtail.config.lokiAddress=http://loki-distributed-loki-headless.monitoring.svc.cluster.local:3100/loki/api/v1/push
      - loki-distributed.promtail.config.client.url=http://loki-distributed-loki-headless.monitoring.svc.cluster.local:3100/loki/api/v1/push
      - loki-distributed.promtail.config.client.batchWait=1s
      - loki-distributed.promtail.config.client.batchSize=1048576
      - loki-distributed.promtail.config.client.timeout=10s
      - loki-distributed.promtail.config.client.backoffConfig.minPeriod=100ms
      - loki-distributed.promtail.config.client.backoffConfig.maxPeriod=5m0s
      - loki-distributed.promtail.config.client.backoffConfig.jitter=true
  - name: kube-prometheus-stack
    namespace: monitoring
    behavior: merge
    literals:
      - kube-prometheus-stack.prometheus.prometheusSpec.serviceMonitorSelector.matchLabels.release=prometheus-operator
      - kube-prometheus-stack.prometheus.prometheusSpec.serviceMonitorNamespaceSelector.matchNames=monitoring
      - kube-prometheus-stack.prometheus.prometheusSpec.podMonitorSelector.matchLabels.release=prometheus-operator
      - kube-prometheus-stack.prometheus.prometheusSpec.podMonitorNamespaceSelector.matchNames=monitoring
      - kube-prometheus-stack.grafana.enabled=true
      - kube-prometheus-stack.grafana.adminUser=admin
      - kube-prometheus-stack.grafana.adminPassword=admin
      - kube-prometheus-stack.grafana.service.type=NodePort
      - kube-prometheus-stack.grafana.service.nodePort=30000
      - kube-prometheus-stack.grafana.ingress.enabled=true
      - kube-prometheus-stack.grafana.ingress.hosts[0].host=grafana.cluster.local
configurations:
  - kustomizeconfig.yml