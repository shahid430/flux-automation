apiVersion: v1
kind: Namespace
metadata:
  name: outline
---
apiVersion: v1
kind: Secret
metadata:
  name: outline-secrets
  namespace: outline
type: Opaque
stringData:
  # Outline secrets
  SECRET_KEY: "3fce1d6b7b32e17c500ffa3d49db7cb615bed88f6d957dcf47f351db976ce940"
  UTILS_SECRET: "e89851c5ad4bede8d06beed230d13ba24de8de405f64c2d6be0a9949a6e0c4c7"

  # Postgres credentials
  POSTGRES_USER: "outline"
  POSTGRES_PASSWORD: "pass"
  POSTGRES_DB: "outline"

  # Connection strings (use Kubernetes service DNS names)
  DATABASE_URL: "postgres://outline:pass@outline-postgres:5432/outline"
  REDIS_URL: "redis://outline-redis:6379"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: outline-redis-config
  namespace: outline
data:
  redis.conf: |
    # Minimal redis config (adjust as needed)
    bind 0.0.0.0
    port 6379
    protected-mode no
    save ""
    appendonly no
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: outline-storage-pvc
  namespace: outline
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  # storageClassName: standard   # <-- set if needed in your cluster
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: outline-postgres-pvc
  namespace: outline
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  # storageClassName: standard   # <-- set if needed in your cluster
---
apiVersion: v1
kind: Service
metadata:
  name: outline-redis
  namespace: outline
spec:
  selector:
    app: outline-redis
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: outline-redis
  namespace: outline
spec:
  replicas: 1
  selector:
    matchLabels:
      app: outline-redis
  template:
    metadata:
      labels:
        app: outline-redis
    spec:
      containers:
        - name: redis
          image: redis:7
          args: ["redis-server", "/redis.conf"]
          ports:
            - containerPort: 6379
          volumeMounts:
            - name: redis-conf
              mountPath: /redis.conf
              subPath: redis.conf
          livenessProbe:
            exec:
              command: ["sh", "-lc", "redis-cli ping | grep -q PONG"]
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          readinessProbe:
            exec:
              command: ["sh", "-lc", "redis-cli ping | grep -q PONG"]
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
      volumes:
        - name: redis-conf
          configMap:
            name: outline-redis-config
---
apiVersion: v1
kind: Service
metadata:
  name: outline-postgres
  namespace: outline
spec:
  selector:
    app: outline-postgres
  ports:
    - name: postgres
      port: 5432
      targetPort: 5432
  type: ClusterIP
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: outline-postgres
  namespace: outline
spec:
  serviceName: outline-postgres
  replicas: 1
  selector:
    matchLabels:
      app: outline-postgres
  template:
    metadata:
      labels:
        app: outline-postgres
    spec:
      containers:
        - name: postgres
          image: postgres:16-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: outline-secrets
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: outline-secrets
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: outline-secrets
                  key: POSTGRES_DB
          volumeMounts:
            - name: pgdata
              mountPath: /var/lib/postgresql/data
          livenessProbe:
            exec:
              command: ["sh", "-lc", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          readinessProbe:
            exec:
              command: ["sh", "-lc", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 6
      volumes:
        - name: pgdata
          persistentVolumeClaim:
            claimName: outline-postgres-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: outline
  namespace: outline
spec:
  selector:
    app: outline
  ports:
    - name: http
      port: 3000
      targetPort: 3000
  type: ClusterIP
---
# OPTIONAL: If you want to access Outline from outside the cluster without Ingress,
# change Service type to NodePort (uncomment below) and remove the ClusterIP Service above.
#
# apiVersion: v1
# kind: Service
# metadata:
#   name: outline
#   namespace: outline
# spec:
#   selector:
#     app: outline
#   ports:
#     - name: http
#       port: 3000
#       targetPort: 3000
#       nodePort: 30000
#   type: NodePort
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: outline
  namespace: outline
spec:
  replicas: 1
  selector:
    matchLabels:
      app: outline
  template:
    metadata:
      labels:
        app: outline
    spec:
      containers:
        - name: outline
          image: docker.getoutline.com/outlinewiki/outline:latest
          ports:
            - containerPort: 3000
          env:
            - name: PGSSLMODE
              value: "disable"
            - name: PORT
              value: "3000"

            # IMPORTANT:
            # If using port-forward, localhost works:
            - name: URL
              value: "https://aidevops.online"

            - name: FORCE_HTTPS
              value: "true""

            - name: FILE_STORAGE
              value: "local"
            - name: FILE_STORAGE_LOCAL_ROOT_DIR
              value: "/var/lib/outline/data"
            - name: FILE_STORAGE_UPLOAD_MAX_SIZE
              value: "26214400"

            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: outline-secrets
                  key: SECRET_KEY
            - name: UTILS_SECRET
              valueFrom:
                secretKeyRef:
                  name: outline-secrets
                  key: UTILS_SECRET

            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: outline-secrets
                  key: DATABASE_URL
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: outline-secrets
                  key: REDIS_URL

          volumeMounts:
            - name: outline-data
              mountPath: /var/lib/outline/data

          # Probes: keep it simple and resilient
          startupProbe:
            tcpSocket:
              port: 3000
            periodSeconds: 5
            failureThreshold: 30
          readinessProbe:
            tcpSocket:
              port: 3000
            periodSeconds: 10
            failureThreshold: 6
          livenessProbe:
            tcpSocket:
              port: 3000
            periodSeconds: 20
            failureThreshold: 6

      volumes:
        - name: outline-data
          persistentVolumeClaim:
            claimName: outline-storage-pvc

